-- ============================================================================
-- MOTTU - Migração para Tabela de Notificações
-- Compatível com Oracle 12c+ (IDENTITY)
-- ============================================================================
-- Este script cria a tabela TB_NOTIFICACAO para o sistema de notificações dinâmicas
-- ============================================================================

-- 1) TABELA TB_NOTIFICACAO
CREATE TABLE TB_NOTIFICACAO (
  id_notificacao           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tipo                     VARCHAR2(20) NOT NULL,
  titulo                   VARCHAR2(200) NOT NULL,
  mensagem                 VARCHAR2(1000) NOT NULL,
  prioridade               VARCHAR2(20) NOT NULL,
  categoria                VARCHAR2(30) NOT NULL,
  lida                     NUMBER(1) DEFAULT 0 NOT NULL,
  data_hora_criacao        TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
  data_hora_leitura        TIMESTAMP,
  dados_contexto           VARCHAR2(2000),
  tb_patio_id_patio        NUMBER,
  tb_box_id_box            NUMBER,
  tb_veiculo_id_veiculo    NUMBER,
  criado_em                TIMESTAMP DEFAULT SYSTIMESTAMP,
  atualizado_em            TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- 2) COMENTÁRIOS DA TABELA E COLUNAS
COMMENT ON TABLE TB_NOTIFICACAO IS 'Sistema de notificações dinâmicas do MOTTU';
COMMENT ON COLUMN TB_NOTIFICACAO.id_notificacao IS 'Identificador único da notificação';
COMMENT ON COLUMN TB_NOTIFICACAO.tipo IS 'Tipo da notificação (INFO, WARNING, ERROR, SUCCESS, ALERT)';
COMMENT ON COLUMN TB_NOTIFICACAO.titulo IS 'Título da notificação';
COMMENT ON COLUMN TB_NOTIFICACAO.mensagem IS 'Mensagem detalhada da notificação';
COMMENT ON COLUMN TB_NOTIFICACAO.prioridade IS 'Prioridade (BAIXA, MEDIA, ALTA, CRITICA)';
COMMENT ON COLUMN TB_NOTIFICACAO.categoria IS 'Categoria (OCUPACAO, MOVIMENTACAO, SISTEMA, etc.)';
COMMENT ON COLUMN TB_NOTIFICACAO.lida IS 'Flag indicando se a notificação foi lida (0=Não, 1=Sim)';
COMMENT ON COLUMN TB_NOTIFICACAO.data_hora_criacao IS 'Data e hora de criação da notificação';
COMMENT ON COLUMN TB_NOTIFICACAO.data_hora_leitura IS 'Data e hora de leitura da notificação';
COMMENT ON COLUMN TB_NOTIFICACAO.dados_contexto IS 'Dados contextuais em JSON';
COMMENT ON COLUMN TB_NOTIFICACAO.tb_patio_id_patio IS 'Referência ao pátio (opcional)';
COMMENT ON COLUMN TB_NOTIFICACAO.tb_box_id_box IS 'Referência ao box (opcional)';
COMMENT ON COLUMN TB_NOTIFICACAO.tb_veiculo_id_veiculo IS 'Referência ao veículo (opcional)';

-- 3) CONSTRAINTS DE VALIDAÇÃO
-- Constraint para validar tipo da notificação
ALTER TABLE TB_NOTIFICACAO ADD CONSTRAINT ck_notif_tipo 
CHECK (tipo IN ('INFO', 'WARNING', 'ERROR', 'SUCCESS', 'ALERT'));

-- Constraint para validar prioridade da notificação
ALTER TABLE TB_NOTIFICACAO ADD CONSTRAINT ck_notif_prioridade 
CHECK (prioridade IN ('BAIXA', 'MEDIA', 'ALTA', 'CRITICA'));

-- Constraint para validar categoria da notificação
ALTER TABLE TB_NOTIFICACAO ADD CONSTRAINT ck_notif_categoria 
CHECK (categoria IN ('OCUPACAO', 'MOVIMENTACAO', 'SISTEMA', 'MANUTENCAO', 'SEGURANCA', 'PERFORMANCE', 'PATIO', 'BOX', 'VEICULO'));

-- Constraint para validar flag lida
ALTER TABLE TB_NOTIFICACAO ADD CONSTRAINT ck_notif_lida 
CHECK (lida IN (0, 1));

-- 4) FOREIGN KEYS (opcionais)
ALTER TABLE TB_NOTIFICACAO ADD CONSTRAINT fk_notif_patio 
FOREIGN KEY (tb_patio_id_patio) REFERENCES TB_PATIO(id_patio);

ALTER TABLE TB_NOTIFICACAO ADD CONSTRAINT fk_notif_box 
FOREIGN KEY (tb_box_id_box) REFERENCES TB_BOX(id_box);

ALTER TABLE TB_NOTIFICACAO ADD CONSTRAINT fk_notif_veiculo 
FOREIGN KEY (tb_veiculo_id_veiculo) REFERENCES TB_VEICULO(id_veiculo);

-- 5) ÍNDICES para performance
CREATE INDEX ix_notif_tipo ON TB_NOTIFICACAO (tipo);
CREATE INDEX ix_notif_prioridade ON TB_NOTIFICACAO (prioridade);
CREATE INDEX ix_notif_categoria ON TB_NOTIFICACAO (categoria);
CREATE INDEX ix_notif_lida ON TB_NOTIFICACAO (lida);
CREATE INDEX ix_notif_data_criacao ON TB_NOTIFICACAO (data_hora_criacao);
CREATE INDEX ix_notif_patio ON TB_NOTIFICACAO (tb_patio_id_patio);
CREATE INDEX ix_notif_box ON TB_NOTIFICACAO (tb_box_id_box);
CREATE INDEX ix_notif_veiculo ON TB_NOTIFICACAO (tb_veiculo_id_veiculo);

-- 6) SEQUÊNCIA para compatibilidade (caso necessário)
CREATE SEQUENCE SEQ_TB_NOTIFICACAO
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- 7) DADOS INICIAIS (notificação de boas-vindas)
INSERT INTO TB_NOTIFICACAO (tipo, titulo, mensagem, prioridade, categoria, lida) VALUES 
('INFO', 'Sistema de Notificações Ativado', 'O sistema de notificações dinâmicas foi ativado com sucesso!', 'BAIXA', 'SISTEMA', 0);

COMMIT;




